<?xml version="1.0" encoding="UTF-8"?>
<odoo>
   <!-- Lista de Visualização para geracad.nfse -->
   <record id="view_geracad_nfse_tree" model="ir.ui.view">
    <field name="name">geracad.nfse.tree</field>
    <field name="model">geracad.nfse</field>
    <field name="arch" type="xml">
        <tree string="NFS-e" default_order="id desc" decoration-muted="state=='draft'" decoration-warning="state=='em_processamento'" decoration-success="state=='concluida'" decoration-danger="state=='erro'">
            <header>
                <button name="action_download_xml_zip" 
                    string="Baixar XMLs (ZIP)" 
                    type="object" 
                    class="btn-primary"
                    icon="fa-download"
                    groups="geracad_curso.group_geracad_curso_finaceiro"/>
                <button name="action_download_pdf_zip" 
                    string="Baixar PDFs (ZIP)" 
                    type="object" 
                    class="btn-primary"
                    icon="fa-file-pdf-o"
                    groups="geracad_curso.group_geracad_curso_finaceiro"/>
            </header>
            <field name="name"/>
            <field name="nfse_provider"/>
            <field name="state" widget="badge" decoration-muted="state=='draft'" decoration-warning="state=='em_processamento'" decoration-success="state=='concluida'" decoration-danger="state=='erro'"/>
            <field name="valor_servico"/>
            <field name="cliente_id"/>
            <field name="nfse_descricao_nota"/>
            <field name="data_emissao"/>
        </tree>
       
    </field>
</record>
   <!-- Search View para geracad.nfse -->
    <record id="view_geracad_nfse_search" model="ir.ui.view">
        <field name="name">geracad.nfse.search</field>
        <field name="model">geracad.nfse</field>
        <field name="arch" type="xml">
            <search string="Buscar NFS-e">
                <!-- Search Panel - Painel lateral de filtros -->
                <searchpanel>
                    <!-- Filtro por Status -->
                    <field name="state" string="Status" icon="fa-tasks" select="multi" enable_counters="1"/>
                    <!-- Filtro por Provedor -->
                    <field name="nfse_provider" string="Provedor" icon="fa-server" select="multi" enable_counters="1"/>
                   
                   
                </searchpanel>
                
                <!-- Campos de busca -->
                <field name="name" string="Número NFS-e"/>
                <field name="cliente_id" string="Sacado"/>
                <field name="state" string="Status"/>
                <field name="data_emissao" string="Data de Emissão"/>
                <field name="create_date" string="Data de Criação"/>
                
                <!-- Filtros por Status -->
                <filter string="Rascunho" name="filter_draft" domain="[('state', '=', 'draft')]"/>
                <filter string="Em Processamento" name="filter_em_processamento" domain="[('state', '=', 'em_processamento')]"/>
                <filter string="Emitida" name="filter_concluida" domain="[('state', '=', 'concluida')]"/>
                <filter string="Erro" name="filter_erro" domain="[('state', '=', 'erro')]"/>
                
                <separator/>
                
                <!-- Filtros de Data de Emissão -->
                <filter string="Data de Emissão" name="filter_data_emissao" date="data_emissao" default_period="this_month"/>
                
                <separator/>
                
                <!-- Filtros de Data de Criação -->
                <filter string="Data de Criação" name="filter_data_criacao" date="create_date" default_period="this_month"/>

                <separator/>

                <!-- Agrupamento -->
                <group expand="0" string="Agrupar Por">
                    <filter string="Sacado" name="group_sacado" context="{'group_by':'cliente_id'}"/>
                    <filter string="Status" name="group_status" context="{'group_by':'state'}"/>
                    <filter string="Data de Emissão: Mês" name="group_data_emissao_month" context="{'group_by':'data_emissao:month'}"/>
                    <filter string="Data de Emissão: Trimestre" name="group_data_emissao_quarter" context="{'group_by':'data_emissao:quarter'}"/>
                    <filter string="Data de Emissão: Ano" name="group_data_emissao_year" context="{'group_by':'data_emissao:year'}"/>
                    <filter string="Data de Criação: Mês" name="group_create_date_month" context="{'group_by':'create_date:month'}"/>
                    <filter string="Data de Criação: Trimestre" name="group_create_date_quarter" context="{'group_by':'create_date:quarter'}"/>
                    <filter string="Data de Criação: Ano" name="group_create_date_year" context="{'group_by':'create_date:year'}"/>
                </group>
            </search>
        </field>
    </record>

     
 <!-- Formulário de Visualização para geracad.nfse -->
 <record id="view_geracad_nfse_form" model="ir.ui.view">
    <field name="name">geracad.nfse.form</field>
    <field name="model">geracad.nfse</field>
    <field name="arch" type="xml">
        <form string="NFS-e">
            <header>
                <button name="action_gerar_nfse" 
                    groups="geracad_curso.group_geracad_curso_finaceiro"
                    string="Enviar NFSe" 
                    type="object"  
                    class="btn-primary"  
                    attrs="{'invisible': [('state', 'in', ['concluida', 'em_processamento', 'cancelada'])]}"/>
               
                <button name="action_get_nfse" 
                    groups="geracad_curso.group_geracad_curso_finaceiro"
                    string="Consultar NFSe" 
                    type="object"  
                    class="btn-secondary"/>
                
                <button name="action_cancelar_nfse" 
                    groups="geracad_curso.group_geracad_curso_finaceiro"
                    string="Cancelar NFSe" 
                    type="object"  
                    class="btn-danger"
                    attrs="{'invisible': [('state', 'in', ['cancelada']), ('state', '!=', 'concluida'), ('nfse_provider', '!=', 'focusnfe')], 'readonly': [('state', '!=', 'concluida')]}"/>
               
                <field name="state" 
                    widget="statusbar" 
                    clickable="1" 
                    statusbar_visible="draft,em_processamento,concluida,erro,cancelada" 
                    statusbar_colors="{'erro':'red','em_processamento':'orange','concluida':'green','cancelada':'red'}"/>
            </header>
            
            <sheet>
                <!-- Ribbons de Status -->
                <widget name="web_ribbon" 
                    title="Emitida" 
                    bg_color="bg-success" 
                    attrs="{'invisible': [('state', '!=', 'concluida')]}"/>
                <widget name="web_ribbon" 
                    title="Erro"  
                    bg_color="bg-danger" 
                    attrs="{'invisible': [('state', '!=', 'erro')]}"/>
                <widget name="web_ribbon" 
                    title="Em Processamento"  
                    bg_color="bg-warning" 
                    attrs="{'invisible': [('state', '!=', 'em_processamento')]}"/>
                <widget name="web_ribbon" 
                    title="Cancelada"  
                    bg_color="bg-danger" 
                    attrs="{'invisible': [('state', '!=', 'cancelada')]}"/>
              
                <div class="oe_title">
                    <label for="name" string="Número da NFS-e"/>
                    <h1>
                        <field name="name" readonly="1" placeholder="Número da NFS-e"/>
                    </h1>
                </div>
                
                <group>
                    <group string="Informações da Nota">
                        <field name="data_emissao" 
                            string="Data de Emissão"
                            attrs="{'readonly': [('state', 'in', ['concluida', 'em_processamento'])]}"/>
                        <field name="aluno_id" 
                            string="Aluno" 
                            options="{'no_create': True}"
                            attrs="{'invisible': [('aluno_id', '=', False)], 'readonly': [('state', 'in', ['concluida', 'em_processamento'])]}"/>
                        <field name="cliente_id" 
                            string="Sacado" 
                            options="{'no_create': True}" 
                            context="{'form_view_ref': 'base.view_partner_form'}"
                            attrs="{'readonly': [('state', 'in', ['concluida', 'em_processamento'])]}"/>
                        <field name="nfse_descricao_nota" 
                            string="Descrição da Nota" 
                            placeholder="Descrição detalhada da nota fiscal"
                            attrs="{'readonly': [('state', 'in', ['concluida', 'em_processamento'])]}"/>
                    </group>
                    
                    <group string="Informações Fiscais">
                        <field name="valor_servico" 
                            string="Valor do Serviço" 
                            widget="monetary"
                            attrs="{'readonly': [('state', 'in', ['concluida', 'em_processamento'])]}"/>
                        <field name="nfse_retido" 
                            string="ISS Retido"
                            attrs="{'readonly': [('state', 'in', ['concluida', 'em_processamento'])]}"/>
                        <field name="regime_especial_tributacao" 
                            string="Regime Especial de Tributação"
                            attrs="{'invisible': [('nfse_provider', '!=', 'focusnfe')], 'readonly': [('state', 'in', ['concluida', 'em_processamento'])]}"/>
                    </group>
                </group>
                
                <group>
                    <group string="Descrição do Serviço">
                        <field name="nfse_CNAE" 
                            string="CNAE" 
                            options="{'no_create': True}"
                            attrs="{'readonly': [('state', 'in', ['concluida', 'em_processamento'])]}"/>
                        <field name="nfse_serviço" 
                            string="Código de Serviço"
                            readonly="1"
                            attrs="{'invisible': [('nfse_CNAE', '=', False)]}"/>
                        <field name="nfse_descricao_servico" 
                            string="Descrição do Serviço"
                            attrs="{'readonly': [('state', 'in', ['concluida', 'em_processamento'])]}"/>
                    </group>
                    
                    <group string="Local de Prestação do Serviço">
                        <field name="nfse_local_estado" 
                            string="Estado" 
                            options="{'no_create': True, 'no_open': True}"
                            attrs="{'readonly': [('state', 'in', ['concluida', 'em_processamento'])]}"/>
                        <field name="nfse_local_cidade" 
                            string="Cidade" 
                            options="{'no_create': True, 'no_open': True}"
                            attrs="{'readonly': [('state', 'in', ['concluida', 'em_processamento'])]}"/>
                    </group>
                </group>

                <notebook>
                    <page string="Respostas da API">
                        <field name="resposta_api_ids">
                            <tree decoration-success="state=='sucesso'" decoration-danger="state=='erro'" decoration-warning="state=='processando'" delete="false" edit="false" create="false">
                                <field name="data_resposta" string="Data/Hora"/>
                                <field name="state" 
                                    widget="badge" 
                                    decoration-success="state=='sucesso'" 
                                    decoration-danger="state=='erro'" 
                                    decoration-warning="state=='processando'"/>
                                <field name="resposta" string="Resposta"/>
                            </tree>
                        </field>
                    </page>
                    
                    <page string="PDF da NFS-e" attrs="{'invisible': [('nfse_pdf', '=', False)]}">
                        <group>
                            <field name="nfse_pdf_url" 
                                widget="url" 
                                readonly="1" 
                                string="URL do PDF (DANFSE)" 
                                attrs="{'invisible': [('nfse_pdf_url', '=', False)]}"/>
                        </group>
                        <field name="nfse_pdf" widget="pdf_viewer"/>
                    </page>
                    
                    <page string="XML da NFS-e" attrs="{'invisible': [('nfse_xml', '=', False)]}">
                        <group>
                            <field name="nfse_xml" filename="nfse_xml_filename"/>
                        </group>
                    </page>
                    
                    <page string="Informações Gerais">
                        <group>
                            <group string="Dados Administrativos">
                                <field name="company_id" 
                                    string="Unidade" 
                                    options="{'no_create': True, 'no_open': True}"
                                    attrs="{'readonly': [('state', 'in', ['concluida', 'em_processamento'])]}"/>
                                <field name="nfse_provider" 
                                    string="Provedor de NFS-e" 
                                    options="{'no_create': True}"
                                    attrs="{'readonly': [('state', 'in', ['concluida', 'em_processamento'])]}"/>
                                <field name="nfse_provider_identifier" 
                                    readonly="1" 
                                    placeholder="Será definido após envio"
                                    attrs="{'invisible': [('nfse_provider_identifier', '=', False)]}"/>
                            </group>
                            
                            <group string="Controle de Envio">
                                <field name="data_autorizacao" 
                                    string="Data de Autorização" 
                                    readonly="1"
                                    attrs="{'invisible': [('data_autorizacao', '=', False)]}"/>
                                <field name="nfse_protocolo" 
                                    string="Protocolo" 
                                    readonly="1"
                                    attrs="{'invisible': [('nfse_protocolo', '=', False)]}"/>
                                <field name="plugnotas_id" 
                                    string="ID PlugNotas" 
                                    readonly="1"
                                    attrs="{'invisible': [('plugnotas_id', '=', False)]}"/>
                            </group>
                        </group>
                    </page>
                    
                </notebook>
                
            </sheet>
            
            <!-- Chatter para auditoria e mensagens -->
            <div class="oe_chatter">
                <field name="message_follower_ids" groups="base.group_user"/>
                <field name="activity_ids"/>
                <field name="message_ids"/>
            </div>
        </form>
    </field>
</record>

<!-- Action Server para Envio em Lote -->
<record id="action_server_enviar_nfse_lote" model="ir.actions.server">
    <field name="name">Enviar NFS-e</field>
    <field name="model_id" ref="model_geracad_nfse"/>
    <field name="binding_model_id" ref="model_geracad_nfse"/>
    <field name="binding_view_types">list</field>
    <field name="state">code</field>
    <field name="code">
if records:
    action = records.action_gerar_nfse()
    </field>
</record>

<!-- Ação para geracad.nfse -->
<record id="action_geracad_nfse" model="ir.actions.act_window">
    <field name="name">NFS-e</field>
    <field name="res_model">geracad.nfse</field>
    <field name="view_mode">tree,form</field>
    <field name="view_id" ref="view_geracad_nfse_tree"/>
</record>
<record id="action_geracad_nfse_sacado" model="ir.actions.act_window">
    <field name="name">Sacados</field>
    <field name="res_model">res.partner</field>
    <field name="view_mode">tree,form</field>
    <field name="view_ids" eval="[(5, 0, 0),
     (0, 0, {'view_mode': 'tree', 'view_id': ref('base.view_partner_tree')}), 
     (0, 0, {'view_mode': 'form', 'view_id': ref('base.view_partner_form')})]"/>
  
</record>
<menuitem id="menu_geracad_nfse" name="NFS-e" parent="geracad_curso.menu_root_financeiro"  sequence="10"/>
<menuitem id="menu_geracad_nfse_emitidas" name="Notas Fiscais de Serviço" parent="geracad_nfse.menu_geracad_nfse" action="action_geracad_nfse" sequence="1"/>
<menuitem id="menu_geracad_nfse_sacados" name="Sacado" parent="geracad_nfse.menu_geracad_nfse" action="action_geracad_nfse_sacado" sequence="2"/>
    <!-- <menuitem id="menu_geracad_nfse" name="NFS-e" parent="account.menu_finance" action="action_geracad_nfse"/> -->
</odoo>
